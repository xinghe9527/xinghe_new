# 创作空间运作逻辑完整文档

> **版本**: 1.1 (已更正)  
> **更新时间**: 2026-01-26  
> **目的**: 详细说明创作空间的每个按键、功能、数据流和上下文关系

## ⚠️ 重要更正说明

**界面布局已确认**:
- ✅ **剧本空间** = 只有剧本编辑器（纯粹的文本编辑界面）
- ✅ **分镜空间** = 所有功能按钮都在这里（角色/场景/物品/批量操作等）

**设计理念**:
- 剧本空间专注于剧本创作，无干扰
- 分镜空间集中所有生成和管理功能

---

## 📋 目录

1. [整体架构](#整体架构)
2. [数据流向图](#数据流向图)
3. [界面结构](#界面结构)
4. [详细功能说明](#详细功能说明)
5. [数据存储机制](#数据存储机制)
6. [API调用关系](#api调用关系)
7. [上下文参考机制](#上下文参考机制)
8. [按键关联关系图](#按键关联关系图)

---

## 1. 整体架构

### 1.1 创作空间层级结构

```
星橙AI动漫制作
├── 主界面 (home_screen.dart)
│   └── 创作空间按钮 → 打开创作模式选择器
│
├── 创作模式选择器 (creation_mode_selector.dart)
│   ├── 故事转剧本 → StoryInputPage
│   ├── 剧本输入 → ScriptInputPage  
│   └── 已有作品 → 直接进入 WorkspacePage
│
└── 作品空间 (WorkspacePage)
    ├── 标题栏
    │   ├── 返回按钮
    │   ├── 作品名称 (16号字体)
    │   └── 设置按钮
    │
    ├── 标签栏
    │   ├── [剧本空间] ← 默认
    │   └── [分镜空间]
    │
    ├── 剧本空间 (Tab 0)
    │   └── 剧本编辑器 (TextField)
    │       └── 多行文本输入，实时自动保存
    │
    └── 分镜空间 (Tab 1 - ProductionSpacePage)
        ├── 工具栏（所有功能按钮都在这里）
        │   ├── [角色] - 浅色渐变 → 打开角色生成页面
        │   ├── [场景] - 浅色渐变 → 打开场景生成页面
        │   ├── [物品] - 浅色渐变 → 打开物品生成页面
        │   ├── [📘] 分镜提示词 → 选择分镜提示词模板
        │   ├── [批量图片] - 浅色渐变 → 批量生成所有分镜图片
        │   ├── [批量视频] - 浅色渐变 → 批量生成所有分镜视频
        │   └── [生成分镜] - 主题渐变 (青绿→蓝色) → 根据剧本生成分镜
        │
        └── 分镜表格 (Excel风格)
            ├── 列1: 图片提示词 (可编辑)
            ├── 列2: 图片预览 (多张，可切换)
            ├── 列3: 视频提示词 (可编辑)
            └── 列4: 视频预览 (可播放)
```

---

## 2. 数据流向图

### 2.1 创作流程数据流

```
用户输入故事/剧本
    ↓
[保存到 SharedPreferences]
    ↓
WorkspacePage 加载
    ↓
┌─────────────────────────────────────────────┐
│              剧本空间 (Tab 0)                 │
│                                              │
│  ┌────────────────────────────────────┐    │
│  │     剧本文本编辑器 (TextField)      │    │
│  │                                     │    │
│  │  实时自动保存 (onChanged)            │    │
│  │  ↓                                  │    │
│  │  work_{workId}.script               │    │
│  └────────────────────────────────────┘    │
│                                              │
│  ⚠️ 注意：剧本空间只有编辑器，没有其他按钮   │
└─────────────────────────────────────────────┘
                    ↓
         切换到分镜空间 (Tab 1)
                    ↓
┌─────────────────────────────────────────────┐
│              分镜空间工具栏                   │
│                                              │
│  [角色] ──→ CharacterGenerationPage          │
│             ├─ 读取: scriptContent           │
│             ├─ 调用 LLM (Mock)                │
│             └─ 保存: characters_{workId}     │
│                                              │
│  [场景] ──→ SceneGenerationPage              │
│             ├─ 读取: scriptContent           │
│             ├─ 调用 LLM (Mock)                │
│             └─ 保存: scenes_{workId}         │
│                                              │
│  [物品] ──→ ItemGenerationPage               │
│             ├─ 读取: scriptContent           │
│             ├─ 调用 LLM (Mock)                │
│             └─ 保存: items_{workId}          │
│                                              │
│  [📘] ──→ 选择分镜提示词模板                  │
│                                              │
│  [生成分镜] ──→ 调用 LLM API (Mock)          │
│      ↓         ├─ 读取: 剧本 + 分镜提示词     │
│   生成提示词    └─ 输出: imagePrompt, videoPrompt│
│      ↓                                       │
│  保存到 storyboards_{workId}                │
│                                              │
│  [批量图片] ──→ 调用图片API (真实)           │
│      ↓         ├─ 读取: imagePrompt + 全局主题│
│   生成图片      └─ 保存: imageUrls[]          │
│                                              │
│  [批量视频] ──→ 调用视频API (真实)           │
│      ↓         ├─ 读取: videoPrompt + 图片    │
│   生成视频      └─ 保存: videoUrls[]          │
└─────────────────────────────────────────────┘
```

### 2.2 存储键值对应关系

```
SharedPreferences 存储结构:

work_{workId}                    ← 作品主数据
├── id: String
├── name: String
├── script: String              ← 剧本内容
├── sourceType: String
├── storyboardPromptName: String
├── storyboardPromptContent: String
├── currentTabIndex: int        ← 标签状态
└── updatedAt: String

storyboards_{workId}            ← 分镜数据
├── globalImageTheme: String    ← 全局图片主题
├── globalVideoTheme: String    ← 全局视频主题
└── storyboards: List<Map>
    └── StoryboardRow
        ├── id: String
        ├── imagePrompt: String
        ├── videoPrompt: String
        ├── imageUrls: List<String>
        ├── videoUrls: List<String>
        ├── selectedImageIndex: int
        ├── selectedImageAssets: List<String>  ← 关联的角色/场景/物品ID
        └── selectedVideoAssets: List<String>

characters_{workId}             ← 角色数据
scenes_{workId}                 ← 场景数据
items_{workId}                  ← 物品数据
```

---

## 3. 界面结构

### 3.1 标题栏 (CustomTitleBar)

| 元素 | 位置 | 功能 | 关联 |
|------|------|------|------|
| **返回按钮** | 左上角 | 退出作品空间，返回主界面 | 触发 `_exitWorkspace()` → 保存作品 → Navigator.pop |
| **作品名称** | 返回按钮右侧 | 显示当前作品名称 (16号字体) | 只读显示，来自 `widget.workName` |
| **设置按钮** | 右上角 | 打开设置页面 | 切换 `_showSettings = true` |
| **最小化** | 右上角 | 最小化窗口 | windowManager.minimize() |
| **最大化** | 右上角 | 最大化/还原窗口 | windowManager.maximize/unmaximize() |
| **关闭** | 右上角 | 关闭窗口 | windowManager.close() |

### 3.2 标签栏

| 按钮 | 功能 | 触发动作 | 数据变化 |
|------|------|----------|----------|
| **[剧本空间]** | 切换到剧本编辑界面 | `_currentTabIndex = 0` | 立即调用 `_saveWork()` 保存状态 |
| **[分镜空间]** | 切换到分镜生成界面 | `_currentTabIndex = 1` | 立即调用 `_saveWork()` 保存状态 |

**⚠️ 重要**: 切换标签时会自动保存当前标签索引，下次打开时恢复上次的标签状态。

### 3.3 剧本空间界面

#### 3.3.1 剧本编辑器（唯一功能）

| 元素 | 功能 | 触发时机 | 保存机制 |
|------|------|----------|----------|
| **TextField** | 编辑剧本内容 | 用户输入 | `onChanged` → 立即调用 `_saveWork()` |
| **提示文本** | 引导用户输入剧本 | 剧本为空时显示 | - |

**界面说明**:
- ✅ 剧本空间**只有剧本编辑器**
- ✅ 简洁的纯文本编辑界面
- ✅ 实时自动保存，无需手动保存
- ✅ 支持多行输入，无行数限制

**⚠️ 重要**: 
- 角色、场景、物品生成按钮**不在剧本空间**
- 这些按钮已移至**分镜空间工具栏**

### 3.4 分镜空间界面 (ProductionSpacePage)

#### 3.4.1 工具栏按钮详解（从左到右）

| 按钮 | 样式 | 功能 | 点击后动作 | API调用 | 数据变化 | 关联影响 |
|------|------|------|------------|---------|----------|----------|
| **[角色]** | 浅色渐变 | 打开角色生成页面 | `_openCharacterGeneration()` → 全屏页面 | 在角色页中调用 LLM (Mock) | 角色页独立保存到 `characters_{workId}` | 返回后重新加载到 `_characters`，可在分镜中引用 |
| **[场景]** | 浅色渐变 | 打开场景生成页面 | `_openSceneGeneration()` → 全屏页面 | 在场景页中调用 LLM (Mock) | 场景页独立保存到 `scenes_{workId}` | 返回后重新加载到 `_scenes`，可在分镜中引用 |
| **[物品]** | 浅色渐变 | 打开物品生成页面 | `_openItemGeneration()` → 全屏页面 | 在物品页中调用 LLM (Mock) | 物品页独立保存到 `items_{workId}` | 返回后重新加载到 `_items`，可在分镜中引用 |
| **[📘]** | 图标按钮 | 打开分镜提示词管理器 | `_openStoryboardPromptManager()` → 对话框 | 无 | 更新 `_storyboardPromptName/Content` | 影响"生成分镜"时使用的提示词模板 |
| **[批量图片]** | 浅色渐变 | 批量生成所有分镜图片 | `_batchGenerateImages()` | ✅ 图片API (真实) | 更新所有 `storyboard.imageUrls[]` | 并发生成 3个/批，跳过已有图片的分镜 |
| **[批量视频]** | 浅色渐变 | 批量生成所有分镜视频 | `_batchGenerateVideos()` | ✅ 视频API (真实) | 更新所有 `storyboard.videoUrls[]` | 并发生成 2个/批，需要先有图片，使用图作为参考 |
| **[生成分镜]** | 主题渐变 (青绿→蓝色) | 根据剧本生成分镜提示词 | `_generateStoryboards()` | ⚠️ LLM API (TODO: 当前Mock) | **替换**整个 `_storyboards` 列表 | **清空所有旧分镜**（包括图片和视频），生成新分镜 |

**⚠️ 关键注意事项**:
- **角色、场景、物品**按钮在**分镜空间**，不在剧本空间
- 这三个按钮打开的是**独立的全屏页面**，有自己的保存机制
- 生成的角色/场景/物品数据会被分镜空间引用（显示为标签）

#### 3.4.2 按钮依赖关系

```
剧本内容 (必需)
    ↓
[生成分镜] ─────→ 生成分镜提示词
    ↓
分镜行创建
    ↓
[批量图片] ─────→ 需要分镜提示词
    ↓
图片生成
    ↓
[批量视频] ─────→ 需要图片作为参考
    ↓
视频生成
```

**依赖链**:
1. **生成分镜** 依赖 → 剧本内容 (必需)
2. **批量图片** 依赖 → 分镜行存在
3. **批量视频** 依赖 → 分镜行有图片

#### 3.4.3 分镜表格结构

| 列 | 内容 | 交互 | 数据绑定 | 保存时机 |
|----|------|------|----------|----------|
| **图片提示词** | TextField 多行输入 | 可编辑 | `storyboard.imagePrompt` | `onChanged` → 立即保存 |
| **图片预览** | 图片网格 (多张) | 点击切换选中 | `storyboard.imageUrls[selectedImageIndex]` | 切换时保存 |
| **视频提示词** | TextField 多行输入 | 可编辑 | `storyboard.videoPrompt` | `onChanged` → 立即保存 |
| **视频预览** | 视频播放器 | 播放/暂停 | `storyboard.videoUrls[0]` | - |

---

## 4. 详细功能说明

### 4.1 剧本空间功能

#### 4.1.1 剧本编辑

**功能**: 用户可以直接编辑剧本文本

**触发**: 在 TextField 中输入文字

**执行流程**:
```
用户输入
    ↓
onChanged 回调
    ↓
_saveWork() 被调用
    ↓
构建 JSON 数据
    ↓
保存到 SharedPreferences
    key: 'work_{workId}'
    value: { script, name, sourceType, ... }
```

**数据变化**:
- `_scriptController.text` 更新
- SharedPreferences 中的 `work_{workId}` 更新

**关联影响**:
- 分镜空间的"生成分镜"会读取这个剧本内容
- 角色/场景/物品生成页会接收这个剧本作为上下文

**仅此而已！** 剧本空间设计为简洁的纯编辑界面，所有其他功能都在分镜空间。

### 4.2 分镜空间功能

**⚠️ 重要说明**: 
- 所有功能按钮都在**分镜空间工具栏**
- 剧本空间只有纯粹的剧本编辑器
- 这样设计是为了让剧本编辑更专注，所有生成操作集中在分镜空间

#### 4.2.1 角色生成按钮 [角色]

**位置**: 分镜空间工具栏最左侧

**功能**: 打开角色生成页面，基于剧本内容生成角色

**点击后执行**:
```dart
Navigator.push(全屏页面)
    ↓
CharacterGenerationPage
    ├─ 接收参数: workId, workName, scriptContent
    ├─ 显示角色列表（如果之前生成过）
    └─ 提供"推理"按钮生成新角色
```

**角色生成页面功能**:
1. **推理按钮**: 调用 LLM 从剧本中提取角色 (⚠️ 当前Mock)
2. **提示词管理**: 选择角色提示词模板
3. **风格参考**: 上传参考图片
4. **生成图片**: 为每个角色生成形象图
5. **素材库**: 从素材库选择角色

**数据保存**:
```
characters_{workId} = {
  characters: [
    {
      name: "角色名称",
      characterInfo: "角色描述",
      imageUrls: ["图片1", "图片2"],
      selectedImageIndex: 0
    }
  ]
}
```

**返回分镜空间后**:
- 重新加载角色数据到 `_characters` 列表
- 在分镜表格中可以引用这些角色（显示为标签）
- 可以在生成图片/视频时，将角色固定描述加入提示词

#### 4.2.2 场景生成按钮 [场景]

**位置**: 分镜空间工具栏，角色按钮右侧

**功能**: 打开场景生成页面，基于剧本内容生成场景

**执行流程**:
```
点击 [场景]
    ↓
打开 SceneGenerationPage (全屏)
    ├─ 传递: workId, workName, scriptContent
    ├─ 推理场景 (LLM - Mock)
    ├─ 生成场景图片 (图片API)
    └─ 保存到 scenes_{workId}
    ↓
返回分镜空间
    ↓
重新加载 _scenes 列表
```

**数据结构**:
```dart
scenes_{workId} = {
  scenes: [
    {
      name: "场景名称",
      sceneInfo: "场景描述",
      imageUrls: ["图片1"],
      selectedImageIndex: 0
    }
  ]
}
```

**与分镜的关联**:
- 分镜表格中可以标记使用了哪些场景
- 生成图片时可以引用场景的固定描述

#### 4.2.3 物品生成按钮 [物品]

**位置**: 分镜空间工具栏，场景按钮右侧

**功能**: 打开物品生成页面，基于剧本内容生成物品

**执行流程**:
```
点击 [物品]
    ↓
打开 ItemGenerationPage (全屏)
    ├─ 传递: workId, workName, scriptContent
    ├─ 推理物品 (LLM - Mock)
    ├─ 生成物品图片 (图片API)
    └─ 保存到 items_{workId}
    ↓
返回分镜空间
    ↓
重新加载 _items 列表
```

**数据结构**:
```dart
items_{workId} = {
  items: [
    {
      name: "物品名称",
      itemInfo: "物品描述",
      imageUrls: ["图片1"],
      selectedImageIndex: 0
    }
  ]
}
```

**⚠️ 三个资产按钮的共同特点**:
1. 都在**分镜空间工具栏**，不在剧本空间
2. 都打开**独立的全屏页面**
3. 都接收**剧本内容作为上下文**
4. 都有**独立的数据存储**
5. 返回后会**重新加载资产列表**
6. 生成的资产可以在分镜中**引用**

#### 4.2.4 分镜提示词按钮 [📘]

**功能**: 选择分镜生成的提示词模板

**点击后**:
```
打开 StoryboardPromptManager 对话框
    ↓
显示预设模板列表:
    - 默认
    - 电影感
    - 动漫风格
    - 唯美画面
    - ...
    ↓
用户选择一个模板
    ↓
更新 _storyboardPromptName
更新 _storyboardPromptContent
    ↓
影响后续"生成分镜"的效果
```

**提示词的作用**:
- 在调用 LLM 生成分镜时，作为系统提示词
- 指导 AI 生成什么风格的分镜描述
- 不影响已生成的分镜

#### 4.2.5 生成分镜按钮 [生成分镜]

**位置**: 分镜空间工具栏最右侧（主题渐变色）

**功能**: 根据剧本内容，自动生成分镜提示词（图片提示词 + 视频提示词）

**前置条件**:
- 剧本内容不为空

**点击后执行流程**:
```
检查剧本内容
    ↓
_isGenerating = true (显示加载中)
    ↓
构建 LLM 提示词:
    - 分镜提示词内容 (_storyboardPromptContent)
    - 剧本内容 (widget.scriptContent)
    - 已有分镜作为上下文 (如果有)
    ↓
调用 LLM API (⚠️ TODO: 当前使用 Mock 数据)
    ↓
解析响应，生成 StoryboardRow 列表
    ↓
_storyboards = 新生成的列表
    ↓
_autoSelectAssets() - 自动选中相关资产
    ↓
_saveProductionData() - 保存分镜数据
    ↓
_isGenerating = false
    ↓
显示成功提示
```

**Mock 数据示例** (当前实现):
```dart
[
  StoryboardRow(
    imagePrompt: '主角站在未来都市天台，俯瞰城市...',
    videoPrompt: '主角转身眺望，镜头从远景推进...',
    selectedImageAssets: ['char_001', 'scene_001'],
  ),
  // ...更多分镜
]
```

**⚠️ 重要**:
- 生成分镜会**替换**所有现有分镜
- 需要先设置好"分镜提示词"以获得更好的效果
- 当前使用 Mock 数据，需要接入真实 LLM API

**数据变化**:
- `_storyboards` 列表被替换
- SharedPreferences 中 `storyboards_{workId}` 更新

**关联影响**:
- 清空所有旧分镜（包括已生成的图片和视频）
- 批量图片/视频按钮可用

#### 4.2.6 批量图片生成按钮 [批量图片]

**功能**: 为所有没有图片的分镜批量生成图片

**前置条件**:
- 分镜列表不为空
- 至少有一个分镜没有图片

**点击后执行流程**:
```
检查分镜列表
    ↓
筛选出没有图片的分镜
    ↓
_isGenerating = true
    ↓
分批处理 (每批 3 个并发)
    ↓
对每个分镜:
    ├─ 构建完整提示词:
    │   globalImageTheme + imagePrompt
    ├─ 调用图片 API (✅ 真实 API)
    ├─ 获取图片 URL
    └─ 更新 storyboard.imageUrls
    ↓
每批完成后保存数据
    ↓
所有批次完成
    ↓
_isGenerating = false
    ↓
显示统计: "成功 X 个，失败 X 个"
```

**API 调用** (RealAIService):
```dart
final imageUrl = await _aiService.generateStoryboardImage(
  prompt: fullPrompt,
);
```

**API 配置来源**:
- 使用 设置 → API设置 → 图片模型
- 读取: provider, model, apiKey, baseUrl

**并发控制**:
- 每批 3 个并发请求
- 避免同时发起过多请求

**数据变化**:
```dart
storyboard.imageUrls = [url1, url2, ...]  // 添加新图片
storyboard.selectedImageIndex = 0         // 默认选中第一张
```

**关联影响**:
- 表格中图片列更新
- 批量视频按钮可用（因为有了参考图片）

**错误处理**:
- 单个失败不影响其他分镜
- 显示成功和失败数量

#### 4.2.7 批量视频生成按钮 [批量视频]

**功能**: 为所有有图片但没有视频的分镜批量生成视频

**前置条件**:
- 分镜列表不为空
- 至少有一个分镜有图片但没有视频

**点击后执行流程**:
```
检查分镜列表
    ↓
筛选出有图片但没有视频的分镜
    ↓
_isGenerating = true
    ↓
分批处理 (每批 2 个并发) ← 视频生成较慢
    ↓
对每个分镜:
    ├─ 构建完整提示词:
    │   globalVideoTheme + videoPrompt
    ├─ 获取参考图片:
    │   imageUrls[selectedImageIndex]
    ├─ 调用视频 API (✅ 真实 API)
    ├─ 获取视频 URL
    └─ 更新 storyboard.videoUrls
    ↓
每批完成后保存数据
    ↓
所有批次完成
    ↓
_isGenerating = false
    ↓
显示统计: "成功 X 个，失败 X 个"
```

**API 调用** (RealAIService):
```dart
final videoUrl = await _aiService.generateVideoClip(
  prompt: fullPrompt,
  imageUrl: referenceImage,  // ← 使用图片作为参考
);
```

**API 配置来源**:
- 使用 设置 → API设置 → 视频模型
- 读取: provider, model, apiKey, baseUrl

**并发控制**:
- 每批 2 个并发请求（比图片更少，因为视频生成耗时更长）

**数据变化**:
```dart
storyboard.videoUrls = [url1]  // 视频URL
```

**关联影响**:
- 表格中视频列更新

#### 4.2.8 分镜表格内的单个操作

**功能**: 选择或编辑分镜提示词模板

**点击后**:
```
打开 StoryboardPromptManager 对话框
    ↓
显示预设提示词列表
    ↓
用户选择一个模板
    ↓
onPromptChanged 回调
    ↓
更新 _storyboardPromptName
更新 _storyboardPromptContent
    ↓
显示提示: "已选择分镜提示词: {name}"
```

**关联影响**:
- 影响"生成分镜"时使用的提示词
- 不影响已生成的分镜

#### 4.2.9 单个分镜的详细操作

**图片提示词编辑**:
```
用户修改 TextField
    ↓
onChanged 回调
    ↓
_storyboards[index].imagePrompt = newValue
    ↓
_saveProductionData() - 立即保存
```

**图片切换**:
```
用户点击不同的图片
    ↓
_storyboards[index].selectedImageIndex = newIndex
    ↓
_saveProductionData() - 立即保存
```

**单个图片生成** (表格内按钮):
```
点击"生成图片"按钮
    ↓
调用图片 API
    ↓
将新图片添加到 imageUrls
    ↓
保存数据
```

---

## 5. 数据存储机制

### 5.1 存储位置

**技术**: SharedPreferences (本地键值存储)

**存储路径**: 
```
Windows: C:\Users\{用户}\AppData\Roaming\{应用名}\shared_preferences.json
```

### 5.2 存储时机

| 操作 | 触发时机 | 保存内容 | 保存键 |
|------|----------|----------|--------|
| **剧本编辑** | onChanged (实时) | 整个作品数据 | `work_{workId}` |
| **切换标签** | 点击标签按钮 | 整个作品数据 | `work_{workId}` |
| **分镜提示词编辑** | onChanged (实时) | 分镜数据 | `storyboards_{workId}` |
| **图片生成** | API 返回后 | 分镜数据 | `storyboards_{workId}` |
| **视频生成** | API 返回后 | 分镜数据 | `storyboards_{workId}` |
| **选择图片** | 点击图片 | 分镜数据 | `storyboards_{workId}` |
| **退出作品空间** | 点击返回按钮 | 整个作品数据 | `work_{workId}` |

### 5.3 数据恢复机制

**进入作品空间时**:
```
WorkspacePage.initState()
    ↓
检查 sourceType
    ↓
如果是 '已有作品':
    ├─ 读取 'work_{workId}'
    ├─ 恢复剧本内容
    ├─ 恢复分镜提示词
    └─ 恢复标签状态
```

**切换到分镜空间时**:
```
ProductionSpacePage.initState()
    ↓
_loadProductionData()
    ├─ 读取 'storyboards_{workId}'
    ├─ 恢复分镜列表
    ├─ 恢复全局主题
    └─ 读取资产引用 (角色/场景/物品)
```

---

## 6. API调用关系

### 6.1 API配置来源

**所有 API 调用都从设置中读取配置**:

```
设置页面 (SettingsPage)
    ↓
SecureStorageManager 存储
    ├─ {provider}_llm_apikey
    ├─ {provider}_llm_url
    ├─ {provider}_llm_model
    ├─ {provider}_image_apikey
    ├─ {provider}_image_url
    ├─ {provider}_image_model
    ├─ {provider}_video_apikey
    ├─ {provider}_video_url
    └─ {provider}_video_model
        ↓
RealAIService 读取配置
    ↓
调用对应的 API
```

### 6.2 API 调用映射表

| 功能 | 使用的API | 当前状态 | 配置来源 | 调用位置 |
|------|-----------|---------|----------|----------|
| **生成剧本** | LLM | ✅ 真实 | LLM模型设置 | StoryInputPage |
| **生成分镜提示词** | LLM | ⚠️ Mock | LLM模型设置 | ProductionSpacePage._generateStoryboards() |
| **批量生成图片** | 图片 | ✅ 真实 | 图片模型设置 | ProductionSpacePage._batchGenerateImages() |
| **批量生成视频** | 视频 | ✅ 真实 | 视频模型设置 | ProductionSpacePage._batchGenerateVideos() |
| **单个生成图片** | 图片 | ✅ 真实 | 图片模型设置 | 表格内按钮 |
| **生成角色** | LLM | ⚠️ Mock | LLM模型设置 | CharacterGenerationPage |
| **生成场景** | LLM | ⚠️ Mock | LLM模型设置 | SceneGenerationPage |
| **生成物品** | LLM | ⚠️ Mock | LLM模型设置 | ItemGenerationPage |

**图例**:
- ✅ 真实: 已接入真实 API
- ⚠️ Mock: 当前使用模拟数据，需要接入真实 API

### 6.3 API 调用示例

#### 图片生成 API 调用

```dart
// 1. 获取配置
final config = await _getImageConfig();
final provider = config['provider'];  // 例如: 'geeknow'
final model = config['model'];        // 例如: 'dall-e-3'

// 2. 构建提示词
String fullPrompt = storyboard.imagePrompt;
if (_globalImageTheme.isNotEmpty) {
  fullPrompt = '$_globalImageTheme, $fullPrompt';
}

// 3. 调用 API
final imageUrl = await _aiService.generateStoryboardImage(
  prompt: fullPrompt,
);
// ↓
ApiRepository.generateImages(
  provider: provider,
  prompt: fullPrompt,
  model: model,
  count: 1,
)
// ↓
根据 provider 选择对应的服务
// ↓
发送 HTTP 请求到 API
// ↓
返回图片 URL
```

---

## 7. 上下文参考机制

### 7.1 剧本内容的传递

**剧本内容是整个创作流程的核心上下文**:

```
剧本编辑器 (_scriptController.text)
    ↓
    保存到 work_{workId}.script
    ↓
    传递给分镜空间
    ↓
┌─────────────────────────────────────────┐
│          分镜空间工具栏                  │
│                                         │
├──→ [角色] → CharacterGenerationPage     │
│             └─ scriptContent 参数        │
│                ↓                        │
│             调用 LLM 提取角色 (Mock)      │
│                ↓                        │
│             保存 characters_{workId}     │
│                                         │
├──→ [场景] → SceneGenerationPage         │
│             └─ scriptContent 参数        │
│                ↓                        │
│             调用 LLM 提取场景 (Mock)      │
│                ↓                        │
│             保存 scenes_{workId}         │
│                                         │
├──→ [物品] → ItemGenerationPage          │
│             └─ scriptContent 参数        │
│                ↓                        │
│             调用 LLM 提取物品 (Mock)      │
│                ↓                        │
│             保存 items_{workId}          │
│                                         │
├──→ [生成分镜] → 调用 LLM (Mock)          │
│                ├─ 读取 scriptContent     │
│                ├─ 读取 分镜提示词         │
│                └─ 生成 imagePrompt/videoPrompt│
│                                         │
└─────────────────────────────────────────┘
```

### 7.2 分镜提示词的传递

```
分镜提示词管理器 (StoryboardPromptManager)
    ↓
选择提示词
    ↓
_storyboardPromptContent
    ↓
传递给 ProductionSpacePage
    ↓
在"生成分镜"时作为 LLM 提示词的一部分
    ↓
影响生成的分镜质量和风格
```

### 7.3 全局主题的应用

**图片全局主题**:
```
_globalImageTheme (用户输入)
    ↓
在生成每个图片时:
    fullPrompt = globalImageTheme + imagePrompt
    ↓
影响所有图片的统一风格
```

**视频全局主题**:
```
_globalVideoTheme (用户输入)
    ↓
在生成每个视频时:
    fullPrompt = globalVideoTheme + videoPrompt
    ↓
影响所有视频的统一风格
```

### 7.4 资产引用机制

**角色/场景/物品的关联**:

```
分镜行 (StoryboardRow)
├─ selectedImageAssets: ['char_001', 'scene_001', 'item_001']
└─ selectedVideoAssets: ['char_001', 'scene_001']
    ↓
在生成分镜时自动检测剧本中提到的实体
    ↓
自动选中相关的角色/场景/物品
    ↓
用户可以在表格中看到关联的资产标签
    ↓
(未来可能用于) 提示词增强 / 一致性检查
```

**资产加载时机**:
```
进入分镜空间
    ↓
_loadAssetReferences()
    ├─ 读取 'characters_{workId}'
    ├─ 读取 'scenes_{workId}'
    └─ 读取 'items_{workId}'
        ↓
    存储在内存中:
        _characters: List<AssetReference>
        _scenes: List<AssetReference>
        _items: List<AssetReference>
```

**资产刷新时机**:
- 从角色/场景/物品生成页返回时
- 调用 `_loadAssetReferences()` 重新加载

---

## 8. 按键关联关系图

### 8.1 完整关联图

```
┌─────────────────────────────────────────────────────────────┐
│                      创作空间主界面                          │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
            ┌───────▼────────┐  ┌──────▼──────────────────────┐
            │   剧本空间      │  │      分镜空间工具栏          │
            │   (Tab 0)      │  │      (Tab 1)               │
            │                │  │                            │
            │ [剧本编辑器]   │  │  [角色] [场景] [物品]      │
            │      ↓         │  │    ↓     ↓     ↓           │
            │  自动保存       │──┼─→ 传递剧本内容             │
            │      ↓         │  │    ↓                       │
            │ scriptContent  │  │  打开独立生成页面           │
            └────────────────┘  │    ↓                       │
                                │  生成并保存资产              │
                                │    ↓                       │
                                │  返回后加载到内存            │
                                │                            │
                                │  [📘] 分镜提示词             │
                                │    ↓                       │
                                │  [生成分镜] ← 读取提示词     │
                                │    ↓                       │
                                │  生成分镜提示词行            │
                                └──────┬─────────────────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
            ┌───────▼────────┐ ┌──────▼──────┐  ┌───────▼────────┐
            │  [批量图片]    │ │ [批量视频]  │  │  [单个生成]    │
            │                │ │             │  │                │
            │ 依赖:          │ │ 依赖:       │  │  依赖:         │
            │ - 分镜存在     │ │ - 图片存在  │  │  - 当前分镜    │
            │ - imagePrompt  │ │ - videoPrompt│  │                │
            │                │ │             │  │                │
            │ 输出:          │ │ 输出:       │  │  输出:         │
            │→imageUrls[]   ├─┤→videoUrls[] │  │→单张图片/视频   │
            └────────────────┘ └─────────────┘  └────────────────┘
```

### 8.2 按钮状态依赖表

**剧本空间按钮**:

| 按钮 | 启用条件 | 禁用条件 | 说明 |
|------|----------|----------|------|
| 无按钮 | - | - | 剧本空间只有编辑器 |

**分镜空间按钮**:

| 按钮 | 启用条件 | 禁用条件 | 执行中状态 |
|------|----------|----------|------------|
| **[角色]** | 始终可用 | 无 | - |
| **[场景]** | 始终可用 | 无 | - |
| **[物品]** | 始终可用 | 无 | - |
| **[📘] 分镜提示词** | 始终可用 | 无 | - |
| **[批量图片]** | 分镜列表不为空 | 分镜为空 OR 正在生成 | 按钮变灰 |
| **[批量视频]** | 至少有一个分镜有图片 | 无图片 OR 正在生成 | 按钮变灰 |
| **[生成分镜]** | 剧本不为空 | 剧本为空 OR 正在生成 | 显示"生成中..." + 白色转圈 |

### 8.3 数据流向关系

```
用户输入剧本
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
存储: work_{workId}.script
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ↓
[生成分镜] ← 读取剧本
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
存储: storyboards_{workId}.storyboards[]
    - imagePrompt
    - videoPrompt
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ↓
[批量图片] ← 读取 imagePrompt
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
存储: storyboards[].imageUrls
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ↓
[批量视频] ← 读取 videoPrompt + imageUrls
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
存储: storyboards[].videoUrls
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 9. 待优化项 (TODO)

### 9.1 需要接入真实 API 的功能

| 功能 | 当前状态 | 位置 | 优先级 |
|------|----------|------|--------|
| **生成分镜** | Mock 数据 | ProductionSpacePage._generateStoryboards() | 🔴 高 |
| **生成角色** | Mock 数据 | CharacterGenerationPage | 🟡 中 |
| **生成场景** | Mock 数据 | SceneGenerationPage | 🟡 中 |
| **生成物品** | Mock 数据 | ItemGenerationPage | 🟡 中 |

### 9.2 建议的改进点

1. **上下文记忆增强**
   - 在生成分镜时，将已有分镜作为上下文传递给 LLM
   - 确保分镜之间的连贯性

2. **资产引用增强**
   - 在生成图片/视频时，将关联的角色/场景固定描述加入提示词
   - 确保角色外观的一致性

3. **批量操作进度显示**
   - 显示当前进度: "正在生成 3/10"
   - 实时更新表格（边生成边显示）

4. **错误恢复机制**
   - 批量生成失败时，标记失败的分镜
   - 提供"重试失败项"按钮

5. **提示词模板系统**
   - 为不同风格预设提示词模板
   - 支持用户自定义模板

---

## 10. 快速参考

### 10.1 文件位置速查

| 功能模块 | 文件路径 |
|---------|---------|
| 作品空间主页 | `lib/features/creation_workflow/presentation/workspace_page.dart` |
| 分镜空间 | `lib/features/creation_workflow/presentation/production_space_page.dart` |
| 角色生成 | `lib/features/creation_workflow/presentation/character_generation_page.dart` |
| 场景生成 | `lib/features/creation_workflow/presentation/scene_generation_page.dart` |
| 物品生成 | `lib/features/creation_workflow/presentation/item_generation_page.dart` |
| 真实AI服务 | `lib/features/creation_workflow/data/real_ai_service.dart` |
| API仓库 | `lib/services/api/api_repository.dart` |
| 安全存储 | `lib/services/api/secure_storage_manager.dart` |

### 10.2 调试技巧

**查看存储的数据**:
```dart
// 在代码中添加
final prefs = await SharedPreferences.getInstance();
print(prefs.getString('work_{workId}'));
print(prefs.getString('storyboards_{workId}'));
```

**清除所有数据** (重置):
```dart
final prefs = await SharedPreferences.getInstance();
await prefs.clear();
```

**查看 API 配置**:
```dart
final storage = SecureStorageManager();
final apiKey = await storage.getApiKey(provider: 'geeknow', modelType: 'image');
print('API Key: $apiKey');
```

---

## 附录 A: 数据模型定义

### StoryboardRow 模型

```dart
class StoryboardRow {
  final String id;                        // 唯一标识
  final String imagePrompt;               // 图片提示词
  final String videoPrompt;               // 视频提示词
  final List<String> imageUrls;           // 图片URL列表
  final List<String> videoUrls;           // 视频URL列表
  final int selectedImageIndex;           // 当前选中的图片索引
  final List<String> selectedImageAssets; // 关联的资产ID (图片)
  final List<String> selectedVideoAssets; // 关联的资产ID (视频)
}
```

### AssetReference 模型

```dart
class AssetReference {
  final String id;           // 资产ID
  final String name;         // 资产名称
  final String? imageUrl;    // 资产图片
  final AssetType type;      // 类型: character/scene/item
}
```

---

**文档结束**

如有任何疑问，请参考源代码或联系开发团队。
