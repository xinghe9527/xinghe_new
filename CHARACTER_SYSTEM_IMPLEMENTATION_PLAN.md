# 角色上传系统实施方案

## 📊 文档分析总结

### 已分析的文档
1. ✅ 架构文档_总索引.md
2. ✅ 架构迁移_检查清单.md（104项）
3. ✅ 架构迁移文档_完整版.md（9章节）
4. ✅ 架构迁移快速参考.md
5. ✅ Sora 创建角色 API 规范

### 核心技术栈
- **存储**: Supabase Storage
- **视频处理**: FFmpeg（打包方案）
- **本地数据**: Hive
- **状态管理**: Provider
- **网络**: Dio + HTTP

## 🎯 角色上传系统流程

### 完整流程图
```
用户操作
    ↓
选择图片 (ImagePicker)
    ↓
FFmpeg 转换为 3秒视频 (720p, MP4)
    ↓
上传到 Supabase Storage
    ↓
获取公共 URL
    ↓
调用 GeekNow Sora API 创建角色
    ↓
保存角色数据到 Hive
    ↓
显示在角色列表
```

## 📋 当前项目状态对比

### ✅ 已完成的部分

**API 层**（刚完成）:
- ✅ GeekNow 服务集成
- ✅ `VeoVideoService.createCharacter()` - Sora 角色创建 API
- ✅ `SoraCharacter` 数据模型
- ✅ Helper 方法：`createCharacterFromUrl()`, `createCharacterFromTask()`
- ✅ 支持从视频 URL 或任务 ID 创建角色

**基础设施**:
- ✅ Flutter 项目框架
- ✅ 主界面（绘图空间、视频空间、设置）
- ✅ 日志系统（LogManager）
- ✅ 安全存储（SecureStorageManager）

**已有依赖**:
- ✅ `http: ^1.2.2`
- ✅ `file_picker: ^10.3.8`
- ✅ `shared_preferences: ^2.3.5`
- ✅ `window_manager: ^0.4.3`

### ❌ 缺少的部分

**存储层**:
- ❌ Supabase 集成和初始化
- ❌ `.env` 文件和环境变量
- ❌ Storage Bucket 上传功能

**处理层**:
- ❌ FFmpeg 服务类
- ❌ 图片转视频功能
- ❌ 视频合并功能
- ❌ FFmpeg 打包配置

**数据层**:
- ❌ 角色数据模型（本地存储）
- ❌ Hive 数据库配置
- ❌ 角色存储服务

**服务层**:
- ❌ 统一上传服务（UploadService）
- ❌ 角色管理服务（CharacterService）

**UI 层**:
- ❌ 角色管理界面
- ❌ 角色列表展示
- ❌ 角色上传按钮
- ❌ 角色卡片组件
- ❌ 角色详情/删除

**依赖包**:
- ❌ `supabase_flutter: ^2.5.6`
- ❌ `flutter_dotenv: ^5.1.0`
- ❌ `image_picker: ^1.2.1`
- ❌ `path_provider: ^2.1.5`
- ❌ `path: ^1.9.0`
- ❌ `hive: ^2.2.3`
- ❌ `hive_flutter: ^1.1.0`
- ❌ `video_player: ^2.8.3`
- ❌ `dio: ^5.9.0`

## 🤔 关键确认问题

### 问题 1: Supabase 使用
**您是否要使用 Supabase 作为文件存储？**

- **选项 A**: 是，使用 Supabase（推荐）
  - 需要：创建 Supabase 项目、配置 Bucket、提供 URL 和 Key
  - 优势：免费 10GB 存储、简单易用、已有完整文档
  
- **选项 B**: 否，使用其他存储（如阿里云 OSS、七牛云等）
  - 需要：提供存储服务的 SDK 和配置方式
  
- **选项 C**: 暂不需要文件存储，直接使用 GeekNow API
  - 限制：无法存储中间文件，依赖外部 URL

**您的选择**: ___

---

### 问题 2: FFmpeg 功能
**您是否需要 FFmpeg 视频处理功能？**

- **选项 A**: 需要（图片转视频、视频合并）
  - 需要：下载 FFmpeg、配置打包、实现服务类
  - 用途：将图片转为 3秒视频后上传
  
- **选项 B**: 不需要
  - 限制：无法将图片转换为视频，只能上传已有的视频文件

**您的选择**: ___

**如果选择 A，还需要哪些功能**：
- [ ] 图片转视频（3秒静态视频）
- [ ] 视频合并（多个场景合并）
- [ ] 提取视频首帧（生成缩略图）
- [ ] 其他（请说明）: _______

---

### 问题 3: 角色管理界面位置
**角色管理界面应该放在哪里？**

- **选项 A**: 新增独立标签页
  ```
  主界面
  ├── 绘图空间
  ├── 视频空间
  ├── 角色管理  ← 新增
  └── 设置
  ```
  - 优势：独立空间、不影响现有界面
  - 实施：创建新页面、添加标签
  
- **选项 B**: 集成到视频空间
  ```
  视频空间
  ├── 视频生成任务（上半部分）
  └── 角色管理（下半部分或侧边）
  ```
  - 优势：使用角色时方便
  - 实施：修改视频空间布局
  
- **选项 C**: 弹窗/对话框
  ```
  视频空间
  ├── 工具栏"角色"按钮
  └── 点击打开角色管理弹窗
  ```
  - 优势：不占用主界面空间
  - 实施：创建弹窗组件

**您的选择**: ___

---

### 问题 4: 角色数据存储
**角色数据需要存储哪些信息？**

**基础方案**（最小化）：
```dart
class Character {
  String id;              // 角色 ID
  String name;            // 角色名称
  String videoUrl;        // Supabase 视频 URL
  DateTime createdAt;     // 创建时间
}
```

**完整方案**（推荐）：
```dart
class Character {
  String id;                    // 角色 ID（Sora API 返回）
  String name;                  // 角色名称
  String username;              // Sora username (@username)
  String videoUrl;              // Supabase 视频 URL
  String? thumbnailUrl;         // 缩略图 URL
  String? description;          // 角色描述
  String? permalink;            // Sora 角色主页
  String? profilePictureUrl;    // Sora 头像
  DateTime createdAt;           // 创建时间
  Map<String, dynamic> metadata; // 其他数据
}
```

**您的选择**: 
- [ ] 基础方案
- [ ] 完整方案
- [ ] 自定义（请说明需要哪些字段）: _______

---

### 问题 5: 角色功能清单
**角色管理需要哪些功能？**

- [ ] 上传角色（选择图片 → 转换 → 上传 → 创建）
- [ ] 角色列表展示（网格或列表视图）
- [ ] 查看角色详情
- [ ] 删除角色
- [ ] 编辑角色信息（名称、描述）
- [ ] 在视频生成时使用角色（引用）
- [ ] 角色搜索/筛选
- [ ] 角色分组/标签
- [ ] 导出/导入角色数据
- [ ] 其他（请说明）: _______

---

### 问题 6: 实施优先级
**请按优先级排序（1 = 最高）**：

- [ ] ___ Supabase 集成
- [ ] ___ FFmpeg 集成
- [ ] ___ 上传服务实现
- [ ] ___ 角色数据存储
- [ ] ___ 角色管理 UI
- [ ] ___ 角色使用功能

---

## 📝 实施方案建议

基于文档分析，我建议采用**渐进式实施**：

### 阶段 1: 基础设施（1-2天）
**目标**: 搭建底层支持

1. 添加依赖包到 `pubspec.yaml`
2. 配置 Supabase（您提供凭证）
3. 配置 FFmpeg（如果需要）
4. 修改 `main.dart` 初始化

**产出**: 
- Supabase 可用
- FFmpeg 可用
- 项目可正常启动

---

### 阶段 2: 服务层（2-3天）
**目标**: 实现核心业务逻辑

1. 创建 `FFmpegService` - 图片转视频
2. 创建 `UploadService` - Supabase 上传
3. 创建 `CharacterStorage` - Hive 存储
4. 创建 `CharacterService` - 统一角色服务

**产出**:
- 可以上传图片并转换为视频
- 可以调用 Sora API 创建角色
- 角色数据可以本地存储

---

### 阶段 3: UI 集成（2-3天）
**目标**: 用户界面

1. 创建角色数据模型
2. 创建角色管理页面（根据您选择的位置）
3. 实现角色列表
4. 实现上传功能
5. 实现角色详情/删除

**产出**:
- 完整的角色管理界面
- 用户可以上传和管理角色

---

### 阶段 4: 功能完善（1-2天）
**目标**: 优化和完善

1. 添加进度指示
2. 错误处理优化
3. 性能优化
4. 添加角色使用功能（在视频生成中引用）

**产出**:
- 完善的用户体验
- 稳定的功能

---

## 🎯 立即需要的信息

### 必需信息

1. **Supabase 配置**（如果选择使用）:
   - Supabase Project URL
   - Supabase Anon Key
   - 或告诉我需要引导您创建

2. **FFmpeg 需求确认**:
   - 是否需要图片转视频？
   - 是否需要视频合并？

3. **界面位置确认**:
   - 选择 A/B/C 哪个方案？

### 可选信息

4. **角色数据字段**:
   - 基础方案还是完整方案？

5. **功能清单**:
   - 勾选需要的功能

6. **优先级排序**:
   - 哪个功能最优先？

---

## 📅 预计时间表

### 如果全部实施

| 阶段 | 工作内容 | 预计时间 |
|------|---------|---------|
| 阶段 1 | 基础设施配置 | 1-2 天 |
| 阶段 2 | 服务层实现 | 2-3 天 |
| 阶段 3 | UI 集成 | 2-3 天 |
| 阶段 4 | 功能完善 | 1-2 天 |
| **总计** | | **6-10 天** |

### 如果最小化实施（仅核心功能）

| 阶段 | 工作内容 | 预计时间 |
|------|---------|---------|
| 快速配置 | Supabase + 依赖包 | 半天 |
| 核心服务 | 上传服务 + 角色创建 | 1 天 |
| 基础 UI | 简单的角色列表和上传 | 1 天 |
| **总计** | | **2.5 天** |

---

## 🚀 我的建议（推荐方案）

### 方案：渐进式实施，最小化界面改动

**第一步：基础设施**（我来实施）
- 添加必要依赖包
- 创建 .env 文件模板
- 创建 FFmpeg 下载脚本
- 修改 main.dart 初始化逻辑

**第二步：Supabase 配置**（您来操作）
- 创建 Supabase 项目（我提供指导）
- 配置 Storage Bucket
- 提供 URL 和 Key 给我

**第三步：服务层**（我来实施）
- 创建 FFmpegService
- 创建 UploadService  
- 创建 CharacterService
- 集成 Sora API

**第四步：UI 集成**（我来实施，您确认）
- 创建独立的角色管理页面（推荐方案 A）
- 不修改现有界面
- 实现角色列表、上传、删除

**第五步：测试验证**（一起完成）
- 功能测试
- 性能测试
- 用户体验优化

---

## ❓ 请您回答

### 必答问题

**1. Supabase**:
- 您选择 A（使用 Supabase）还是 B（其他存储）？
- 如果选 A：是否已有 Supabase 账号？

**2. FFmpeg**:
- 您选择 A（需要）还是 B（不需要）？
- 如果选 A：需要哪些功能（图片转视频/视频合并/提取首帧）？

**3. 界面位置**:
- 您选择 A（独立标签页）、B（集成到视频空间）还是 C（弹窗）？

### 可选问题

**4. 角色数据**: 基础方案还是完整方案？

**5. 功能优先级**: 您最希望先实现哪个功能？

---

## 📝 待办事项（根据您的回答）

### 如果您选择：Supabase + FFmpeg + 独立标签页

**我会立即创建**:
1. ✅ `pubspec.yaml` 更新（添加所有依赖）
2. ✅ `.env.example` 模板文件
3. ✅ `download_ffmpeg.ps1` 脚本
4. ✅ `lib/services/ffmpeg_service.dart`
5. ✅ `lib/services/upload_service.dart`
6. ✅ `lib/services/character_service.dart`
7. ✅ `lib/models/character.dart`
8. ✅ `lib/features/character/character_page.dart`
9. ✅ 修改 `lib/main.dart`（添加初始化）
10. ✅ 修改 `lib/features/home/presentation/home_screen.dart`（添加标签）

**您需要做**:
1. 🔑 创建 Supabase 项目
2. 🔑 创建 Storage Bucket
3. 🔑 提供 Supabase URL 和 Key
4. 🔑 运行 `download_ffmpeg.ps1`
5. 🔑 运行 `flutter pub get`
6. ✅ 测试验证

---

## 📞 下一步

**请您回答上面的 3 个必答问题**（Supabase、FFmpeg、界面位置），我会根据您的回答：

1. 📋 制定详细的任务清单
2. 📂 列出所有需要创建/修改的文件
3. 🚀 开始实施
4. ✅ 逐步验证每个功能

**重要承诺**:
- ✅ 不会修改您现有的界面
- ✅ 所有新功能作为独立模块添加
- ✅ 每个步骤都会与您确认
- ✅ 提供完整的测试方法

---

**文档创建日期**: 2026-01-27
**状态**: 等待您的确认
