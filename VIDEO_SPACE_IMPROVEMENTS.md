# 视频空间功能改进

## ✨ 本次更新内容

### 1️⃣ **文本框全区域可点击**
### 2️⃣ **批量生成功能**

---

## 📝 改进1：文本框全区域可点击

### 🐛 问题描述
之前只有文本框**第一行**可以点击输入，空白区域点击无效。

### ✅ 修复方案

#### 添加焦点节点
```dart
class _TaskCardState extends State<TaskCard> {
  late final FocusNode _focusNode;  // ✅ 添加焦点管理
  
  @override
  void initState() {
    super.initState();
    _focusNode = FocusNode();  // ✅ 初始化
  }
  
  @override
  void dispose() {
    _focusNode.dispose();  // ✅ 清理
    super.dispose();
  }
}
```

#### 改进布局结构
```dart
// 修改前 ❌
Listener(
  child: Container(
    child: SingleChildScrollView(  // ❌ 阻止点击事件
      child: TextField(...),
    ),
  ),
)

// 修改后 ✅
MouseRegion(
  cursor: SystemMouseCursors.text,  // ✅ 鼠标变 I 光标
  child: GestureDetector(
    onTap: () => _focusNode.requestFocus(),  // ✅ 点击时获得焦点
    child: Container(
      child: TextField(
        focusNode: _focusNode,
        maxLines: null,  // ✅ 多行输入
        textAlignVertical: TextAlignVertical.top,  // ✅ 从顶部开始
        ...
      ),
    ),
  ),
)
```

### 🎯 效果对比

#### 修复前
```
┌──────────────────────────────┐
│ 输入视频描述...         👆   │ ← 只有这里能点
│                         👆   │ ← 点击无效
│                         👆   │ ← 点击无效
└──────────────────────────────┘
```

#### 修复后
```
┌──────────────────────────────┐
│ 输入视频描述...         I    │ ← 可点击 ✅
│                         I    │ ← 可点击 ✅
│                         I    │ ← 可点击 ✅
└──────────────────────────────┘
整个区域都能点击！
```

---

## 📝 改进2：批量生成功能

### 🎯 功能说明
一键并发执行界面上所有视频任务，每个任务按其批量设置生成。

### 🎨 按钮设计

#### 位置
```
工具栏右侧（从右到左）:
[清空全部]  [批量生成]  [新建任务]
```

#### 样式
```dart
颜色: 🟧 橙红色渐变 (#FF6B6B → #FF8E53)
图标: ⚡ flash_on (闪电)
文字: "批量生成"
尺寸: 与"新建任务"完全一致
```

#### 状态显示
| 状态 | 图标 | 文字 | 外观 |
|------|------|------|------|
| 可用 | ⚡ | 批量生成 | 🟧 橙红色，可点击 |
| 生成中 | ⏳ | 生成中... | ⚫ 灰色，禁用 |
| 无任务 | ⚡ | 批量生成 | ⚫ 半透明，禁用 |

---

### ⚙️ 核心功能

#### 1. 批量生成入口
```dart
Future<void> _generateAllTasks() async {
  // 筛选有提示词的任务
  final tasksToGenerate = _tasks
      .where((t) => t.prompt.trim().isNotEmpty)
      .toList();
  
  // 并发执行所有任务
  await Future.wait(
    tasksToGenerate.map((task) => _generateSingleTask(task)),
    eagerError: false,
  );
}
```

#### 2. 单任务生成
```dart
Future<void> _generateSingleTask(VideoTask task) async {
  // 1. 添加占位符（按批量数量）
  // 2. 读取API配置
  // 3. 创建服务（支持ComfyUI/GeekNow等）
  // 4. 根据服务商类型选择生成模式：
  //    - ComfyUI: 同步生成
  //    - 其他: 异步轮询
  // 5. 下载并保存视频
  // 6. 替换占位符为真实路径
}
```

#### 3. 辅助方法
```dart
_downloadSingleVideoForTask()  // 下载单个视频
_parseSeconds()                // 解析时长
_convertRatioToSize()          // 转换比例为尺寸
```

---

### 🚀 使用示例

#### 场景：批量创作不同主题视频

```
任务1: "猫咪在玩耍" 
  - 比例: 16:9
  - 时长: 5秒
  - 批量: 2

任务2: "狗狗在奔跑"
  - 比例: 9:16
  - 时长: 10秒
  - 批量: 3

任务3: "兔子在跳跃"
  - 比例: 1:1
  - 时长: 15秒
  - 批量: 1

点击"批量生成"
↓
并发执行3个任务
↓
任务1 生成 2 个视频
任务2 生成 3 个视频
任务3 生成 1 个视频
↓
共获得 6 个视频！
```

---

### 📊 效率对比

#### 手动模式
```
点击任务1生成 → 等待5分钟
点击任务2生成 → 等待5分钟
点击任务3生成 → 等待5分钟

总耗时: 15分钟
操作次数: 3次
```

#### 批量模式
```
点击"批量生成" → 3个任务同时进行

总耗时: 5分钟（并发）
操作次数: 1次
效率提升: 3倍！⚡
```

---

### 🔍 智能特性

#### 自动过滤
- ✅ 只执行有提示词的任务
- ✅ 自动跳过空任务
- ✅ 每个任务独立处理

#### 错误隔离
- 单任务失败不影响其他任务
- 失败的任务显示"生成失败"图标
- 详细错误日志记录

#### 服务商支持
- ✅ ComfyUI（本地）- 同步生成
- ✅ GeekNow - 异步轮询
- ✅ Yunwu - 异步轮询
- ✅ OpenAI - 异步轮询

---

### 🎊 完整工作流程

```
1. 用户准备
   ├─ 创建多个视频任务
   ├─ 每个任务设置提示词
   ├─ 配置比例、时长、批量
   └─ 可选：添加参考图片

2. 点击批量生成
   └─ 按钮变为"生成中..."

3. 并发执行
   ├─ 任务1: 提交 → 轮询 → 下载
   ├─ 任务2: 提交 → 轮询 → 下载
   └─ 任务3: 提交 → 轮询 → 下载

4. 实时显示
   ├─ 占位符显示进度条
   ├─ 完成后显示缩略图
   └─ 失败显示红色图标

5. 自动保存
   └─ 所有视频保存到本地路径
```

---

## 🎨 视觉设计

### 按钮对比
```
┌────────┐  ┌────────┐  ┌────────┐
│清空全部│  │批量生成│  │新建任务│
│  🗑️   │  │  ⚡    │  │  ➕   │
│灰色框  │  │橙红色  │  │青绿色  │
└────────┘  └────────┘  └────────┘
```

### 颜色语义
- 🟢 **青绿色** - 新建/创建（积极操作）
- 🟧 **橙红色** - 批量/快速（高效操作）
- ⚫ **灰色** - 删除/清空（危险操作）

---

## 📋 使用指南

### 步骤1：准备任务
1. 打开**视频空间**
2. 创建多个任务（点击"新建任务"）
3. 每个任务设置：
   - 提示词
   - 比例（16:9/9:16等）
   - 时长（5秒/10秒/15秒）
   - 批量数量（1-20）

---

### 步骤2：执行批量生成
1. 确认所有任务都有提示词
2. 点击工具栏的 **"批量生成"** 按钮
3. 观察：
   - 按钮变为"生成中..."
   - 所有任务卡片右侧显示加载占位符
   - 占位符显示生成进度（0% → 100%）

---

### 步骤3：查看结果
- 视频生成完成后自动显示缩略图
- 点击缩略图可以播放
- 右键可以查看文件夹、复制链接等
- 所有视频自动保存到设置的保存路径

---

## 🔧 技术细节

### 支持的服务商

#### ComfyUI（同步模式）
```dart
if (provider == 'comfyui') {
  // 直接生成，内部已处理轮询
  final result = await service.generateVideos(...);
  // 立即返回视频URL
}
```

#### 其他服务（异步模式）
```dart
else {
  // 步骤1：提交任务，获取taskId
  final result = await service.generateVideos(...);
  final taskId = result.data.first.videoId;
  
  // 步骤2：轮询任务状态
  final statusResult = await helper.pollTaskUntilComplete(
    taskId: taskId,
    onProgress: (progress) {
      // 实时更新进度条
    },
  );
  
  // 步骤3：获取视频URL
  final videoUrl = statusResult.data.videoUrl;
}
```

---

### 占位符机制
```dart
占位符ID格式: 
'loading_${时间戳}_${任务ID}_${索引}'

例如:
'loading_1770052955421_task123_0'
'loading_1770052955421_task123_1'

用途:
1. 在生成过程中显示进度条
2. 完成后替换为真实视频路径
3. 失败后替换为 'failed_' 开头的标记
```

---

### 下载策略
```dart
1. 检查保存路径配置
2. 从API获取视频URL
3. 下载视频数据（最多等待5分钟）
4. 保存到本地（自动生成文件名）
5. 提取首帧作为缩略图
6. 返回本地文件路径
```

---

## 💡 最佳实践

### 1. 合理设置批量
```
✅ 推荐: 每个任务批量 1-3
   原因: 视频生成慢，批量太多等待时间长

❌ 不推荐: 批量 10+
   原因: 单个任务可能需要20-30分钟
```

### 2. 分批执行
```
✅ 推荐: 
   - 第一批: 3个任务，批量1
   - 等待完成后
   - 第二批: 3个任务，批量1

❌ 不推荐:
   - 一次性10个任务，每个批量5
   - 总共50个视频，可能等待数小时
```

### 3. 主题分组
```
✅ 推荐: 按主题分组任务
   组1: 自然风景（3个任务）
   组2: 城市街景（3个任务）
   组3: 人物活动（3个任务）
   
   分批执行，结果更清晰
```

---

## 🎉 功能总结

### ✨ 文本框改进
- 整个区域都能点击
- 鼠标自动变成文本光标
- 体验和专业编辑器一样

### ✨ 批量生成功能
- 一键执行所有任务
- 并发生成，效率翻倍
- 每个任务独立配置批量
- 智能过滤和错误处理

### ✨ 视觉设计
- 橙红色渐变按钮，醒目易识别
- 按钮长度统一，美观整洁
- 实时状态反馈，清晰直观

---

## 📊 修改文件

### `lib/features/home/presentation/video_space.dart`

**新增内容**:
- `FocusNode _focusNode` - 焦点节点
- `_batchGenerateAllButton()` - 批量生成按钮UI
- `_generateAllTasks()` - 批量生成入口
- `_generateSingleTask()` - 单任务生成逻辑
- `_downloadSingleVideoForTask()` - 视频下载
- `_parseSeconds()` - 时长解析
- `_convertRatioToSize()` - 比例转换

**修改内容**:
- 文本框布局（移除 Listener 和 SingleChildScrollView）
- 工具栏添加批量生成按钮
- 焦点节点的初始化和清理

---

## 🔄 测试步骤

### 1. 测试文本框
1. 重启应用
2. 打开**视频空间**
3. 鼠标移到文本框 → 变成 `I` 光标 ✅
4. 点击文本框顶部 → 可以输入 ✅
5. 点击文本框中间 → 可以输入 ✅
6. 点击文本框底部 → 可以输入 ✅

---

### 2. 测试批量生成
1. 创建3个任务
2. 每个任务：
   - 输入提示词
   - 设置批量（1-3）
   - 配置比例和时长
3. 点击 **"批量生成"** 按钮
4. 观察：
   - 按钮变"生成中..."
   - 所有任务开始生成
   - 实时显示进度
   - 完成后显示视频

---

## 🎊 总结

现在视频空间和绘图空间功能完全一致：

| 功能 | 绘图空间 | 视频空间 |
|------|---------|---------|
| 文本框全区域可点击 | ✅ | ✅ |
| 批量生成按钮 | ✅ | ✅ |
| 并发执行任务 | ✅ | ✅ |
| 独立批量设置 | ✅ | ✅ |
| 实时进度显示 | ✅ | ✅ |
| 错误隔离处理 | ✅ | ✅ |

统一的用户体验，更高的创作效率！🚀

---

**更新时间**: 2026-02-03
**功能状态**: ✅ 已完成
