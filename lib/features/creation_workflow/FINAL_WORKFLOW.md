# 完整创作流程说明 v3.0

## 🎯 核心流程

```
创作空间
    ↓
点击"创建作品"
    ↓
【输入作品名称对话框】
    ↓
输入名称，点击"确定"
    ↓
✅ 作品立即创建并添加到作品列表
    ↓
【选择界面】
    ┌─────────┴─────────┐
    ↓                   ↓
故事输入              剧本输入
    ↓                   ↓
【故事→剧本】         【直接输入】
    ↓                   ↓
生成剧本              输入剧本
    ↓                   ↓
点击"下一步" ←─────────┘
    ↓
【作品空间】
    ├─ 剧本空间（可编辑）
    ├─ 角色管理
    ├─ 场景管理
    ├─ 物品管理
    └─ 下一步...
    ↓
随时返回（作品已保存在列表中）
```

---

## 📋 详细步骤

### 步骤1️⃣：创建作品

**操作**：
1. 在创作空间点击"创建作品"按钮

**界面**：
```
┌─────────────────┐
│  创建新作品      │
├─────────────────┤
│  ┌───────────┐  │
│  │作品名称   │  │
│  └───────────┘  │
│   [取消] [确定] │
└─────────────────┘
```

**结果**：
- ✅ 输入名称（例如："我的第一部动漫"）
- ✅ 点击"确定"
- ✅ **作品立即创建并出现在作品列表中**
- ✅ 生成唯一ID（时间戳）
- ✅ 自动进入下一步

---

### 步骤2️⃣：选择创作方式

**界面**：
```
┌──────────────────────────────────────────────┐
│  ← 我的第一部动漫 - 选择创作方式    [-][□][×] │
├──────────────────────────────────────────────┤
│                                              │
│         ┌─────────┐      ┌─────────┐        │
│         │   📖    │      │   📄    │        │
│         │故事输入 │      │剧本输入 │        │
│         │────────│      │────────│        │
│         │AI生成   │      │直接输入 │        │
│         └─────────┘      └─────────┘        │
│                                              │
└──────────────────────────────────────────────┘
```

**标题栏功能**：
- 🖱️ 拖动：点击标题栏空白处拖动窗口
- ➖ 最小化：点击 [-] 按钮
- ⬜ 最大化/还原：点击 [□] 按钮
- ❌ 关闭：点击 [×] 按钮

**操作**：
- 点击"故事输入" → 进入故事输入页面
- 点击"剧本输入" → 进入剧本输入页面

---

### 步骤3️⃣-A：故事输入（路径A）

**界面**：
```
┌──────────────────────────────────────────────┐
│  ← 我的第一部动漫 - 故事输入      [-][□][×]  │
├──────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────────────┐  │
│  │ 故事内容    │  │ 生成的剧本            │  │
│  │             │  │ [提示词▼][生成剧本][下一步] │
│  │ (粘贴故事)  │  │                      │  │
│  │             │  │ (显示生成的剧本)     │  │
│  │             │  │                      │  │
│  │             │  │ • 自动保存           │  │
│  └─────────────┘  └──────────────────────┘  │
└──────────────────────────────────────────────┘
```

**功能**：
1. **左边文本框**：粘贴或输入故事
2. **提示词按钮**（小）：
   - 点击打开提示词预设管理器
   - 选择或创建提示词预设
3. **生成剧本按钮**（大）：
   - 使用选择的提示词预设
   - 调用设置中的LLM模型
   - 在右边生成剧本
4. **下一步按钮**：
   - 进入作品空间
   - 剧本不为空时启用

**数据保存**：
- ✅ 故事内容自动保存
- ✅ 生成的剧本自动保存
- ✅ 关联到作品ID

---

### 步骤3️⃣-B：剧本输入（路径B）

**界面**：
```
┌──────────────────────────────────────────────┐
│  ← 我的第一部动漫 - 剧本输入      [-][□][×]  │
├──────────────────────────────────────────────┤
│  ┌──────────────────────────────────────┐   │
│  │ 剧本内容              [下一步] →    │   │
│  ├──────────────────────────────────────┤   │
│  │                                      │   │
│  │ (粘贴或输入剧本)                     │   │
│  │                                      │   │
│  │ • 自动保存                           │   │
│  │                                      │   │
│  └──────────────────────────────────────┘   │
└──────────────────────────────────────────────┘
```

**功能**：
1. **文本框**：粘贴或输入剧本
2. **下一步按钮**（右上角）：
   - 剧本不为空时启用
   - 进入作品空间

**数据保存**：
- ✅ 剧本内容自动保存
- ✅ 关联到作品ID

---

### 步骤4️⃣：作品空间

**界面**：
```
┌──────────────────────────────────────────────┐
│  ← 我的第一部动漫 - 作品空间      [-][□][×]  │
│    来源：故事输入                             │
├──────────────────────────────────────────────┤
│  ┌──────────────────────────────────────┐   │
│  │ 剧本空间  [角色][场景][物品][下一步] │   │
│  ├──────────────────────────────────────┤   │
│  │                                      │   │
│  │ 第一幕：都市之夜                     │   │
│  │                                      │   │
│  │ 【场景：未来都市...】               │   │
│  │                                      │   │
│  │ 主角站在天台边缘...                 │   │
│  │                                      │   │
│  │ • 可编辑                             │   │
│  │ • 自动保存                           │   │
│  │                                      │   │
│  └──────────────────────────────────────┘   │
└──────────────────────────────────────────────┘
```

**功能**：
1. **剧本编辑区**：
   - 显示剧本内容
   - 可以编辑修改
   - 实时自动保存

2. **工具按钮**（右上角）：
   - **角色**：管理角色（待实现）
   - **场景**：管理场景（待实现）
   - **物品**：管理物品（待实现）
   - **下一步**：进入后续流程（待实现）

---

## 💾 数据存储结构

### 作品数据（work_{workId}）
```json
{
  "id": "1738070400000",
  "name": "我的第一部动漫",
  "story": "原始故事内容...",  // 仅故事输入有
  "script": "第一幕：都市之夜...",
  "sourceType": "故事输入",  // 或 "剧本输入"
  "updatedAt": "2026-01-28T10:00:00.000Z"
}
```

### 作品列表（creation_works）
```json
[
  {
    "id": "1738070400000",
    "title": "我的第一部动漫",
    "createdAt": "2026-01-28T10:00:00.000Z",
    "coverImage": null
  },
  {
    "id": "1738070500000",
    "title": "作品2",
    "createdAt": "2026-01-28T11:00:00.000Z",
    "coverImage": "/path/to/cover.png"
  }
]
```

---

## 🔄 完整流程示例

### 场景1：故事输入创作

```
用户操作流程：
1. 点击"创建作品"
   ↓
2. 输入"我的第一部动漫"，点击"确定"
   → ✅ 作品卡片出现在列表中
   ↓
3. 自动进入选择界面
   ↓
4. 点击"故事输入"
   ↓
5. 在左边粘贴故事：
   "在一个赛博朋克世界..."
   ↓
6. 点击"提示词"选择"详细版"
   ↓
7. 点击"生成剧本"
   ↓
8. 等待2秒，右边显示生成的剧本
   ↓
9. 点击"下一步"
   ↓
10. 进入作品空间，显示剧本
    ↓
11. 编辑剧本（自动保存）
    ↓
12. 点击返回
    ↓
13. 回到创作空间，看到"我的第一部动漫"卡片
```

### 场景2：剧本输入创作

```
用户操作流程：
1. 点击"创建作品"
   ↓
2. 输入"作品2"，点击"确定"
   → ✅ 作品卡片出现在列表中
   ↓
3. 自动进入选择界面
   ↓
4. 点击"剧本输入"
   ↓
5. 粘贴剧本内容
   ↓
6. 点击"下一步"（右上角）
   ↓
7. 进入作品空间
   ↓
8. 编辑剧本（自动保存）
   ↓
9. 返回
```

### 场景3：编辑已有作品

```
用户操作流程：
1. 在创作空间点击"我的第一部动漫"卡片
   ↓
2. 自动加载之前的剧本内容
   ↓
3. 继续编辑
   ↓
4. 所有修改自动保存
   ↓
5. 返回
```

### 场景4：多作品独立性

```
创建3个作品：
├─ 作品1："我的第一部动漫"（故事输入）
│   └─ 数据保存在：work_1738070400000
├─ 作品2："赛博朋克冒险"（剧本输入）
│   └─ 数据保存在：work_1738070500000
└─ 作品3："奇幻世界"（故事输入）
    └─ 数据保存在：work_1738070600000

✅ 三个作品完全独立
✅ 数据互不影响
✅ 可以随意切换编辑
```

---

## 🎨 界面特性

### 标题栏（所有副界面）

**位置**：所有弹出页面的顶部

**组成**：
```
[ ← ] [ 作品名称 - 页面标题 ]        [ - ][ □ ][ × ]
```

**功能**：
- **← 返回**：返回上一页
- **拖动**：点击标题栏空白处拖动窗口
- **- 最小化**：最小化窗口
- **□ 最大化**：切换最大化/还原
- **× 关闭**：关闭当前页面

**实现**：
```dart
GestureDetector(
  onPanStart: (details) {
    windowManager.startDragging();
  },
  child: AppBar(...),
)
```

### 颜色主题

**配色方案**：
- 背景：#161618
- 卡片：#1E1E20
- 按钮背景：#3A3A3C
- 按钮文字：#888888（灰色）
- 次要文字：#666666
- 边框：#2A2A2C

**选择界面渐变**：
- 故事输入：紫色渐变（#667eea → #764ba2）
- 剧本输入：粉色渐变（#f093fb → #F5576C）

---

## 💾 自动保存机制

### 保存时机

1. **故事输入页面**：
   - 生成剧本后自动保存
   - 包含：故事内容 + 生成的剧本

2. **剧本输入页面**：
   - 每次编辑（onChanged）自动保存
   - 包含：剧本内容

3. **作品空间**：
   - 每次编辑（onChanged）自动保存
   - 包含：完整的剧本数据

### 保存内容

**作品数据**（work_{workId}）：
- id：作品ID
- name：作品名称
- story：故事内容（仅故事输入）
- script：剧本内容
- sourceType：来源类型
- updatedAt：更新时间

**作品列表**（creation_works）：
- 在创建作品时立即添加
- 包含基本信息：id、title、createdAt、coverImage

---

## ✅ 关键特性

### 1. 立即创建
- 输入名称后**立即创建**作品
- 不需要完成所有步骤
- 作品立即出现在列表中

### 2. 完全独立
- 每个作品有独立的ID
- 数据独立存储
- 互不影响

### 3. 随时返回
- 任何步骤都可以返回
- 作品保留在列表中
- 下次点击继续编辑

### 4. 自动保存
- 所有编辑实时保存
- 无需手动保存
- 数据持久化

### 5. 窗口管理
- 所有副界面支持拖动
- 支持最小化/最大化
- 支持关闭

---

## 🎬 用户体验

### 场景：创建作品后立即查看

```
1. 点击"创建作品"
2. 输入"测试作品"
3. 点击"确定"
4. 👀 看到"测试作品"卡片出现在列表中
5. 选择界面打开
6. 点击返回（不选择任何方式）
7. 👀 "测试作品"仍然在列表中
8. 再次点击"测试作品"卡片
9. 进入作品空间（剧本为空）
```

**结果**：✅ 作品已创建，即使没有输入内容

### 场景：切换多个作品编辑

```
1. 创建作品A："动漫1"
2. 选择故事输入 → 生成剧本 → 进入作品空间
3. 编辑剧本A
4. 返回创作空间
5. 创建作品B："动漫2"
6. 选择剧本输入 → 输入剧本 → 进入作品空间
7. 编辑剧本B
8. 返回创作空间
9. 点击"动漫1"卡片
10. 👀 看到之前编辑的剧本A（自动加载）
11. 继续编辑
```

**结果**：✅ 多作品独立，数据不丢失

---

## 🔧 技术实现

### 工作流传递

```dart
// 1. 创建作品
_createNewWork() {
  // 输入名称
  // 创建作品并添加到列表
  // 打开选择界面（传入 workId 和 workName）
}

// 2. 选择界面
CreationModeSelector(workId: '123', workName: '我的作品') {
  // 传递给故事输入或剧本输入
}

// 3. 故事输入/剧本输入
StoryInputPage(workId: '123', workName: '我的作品') {
  // 保存数据到 work_123
  // 传递给作品空间
}

// 4. 作品空间
WorkspacePage(workId: '123', workName: '我的作品') {
  // 加载 work_123 的数据
  // 编辑并自动保存
}
```

### 窗口管理

```dart
// 使用 window_manager 包
import 'package:window_manager/window_manager.dart';

// 拖动窗口
GestureDetector(
  onPanStart: (details) {
    windowManager.startDragging();
  },
  child: AppBar(...),
)

// 最小化
windowManager.minimize()

// 最大化/还原
if (await windowManager.isMaximized()) {
  windowManager.unmaximize();
} else {
  windowManager.maximize();
}
```

---

## 📦 文件结构

```
lib/features/creation_workflow/presentation/
├── creation_mode_selector.dart      # 选择界面
├── story_input_page.dart            # 故事输入
├── script_input_page.dart           # 剧本输入
├── prompt_preset_manager.dart       # 提示词管理
├── workspace_page.dart              # 作品空间
└── (旧文件待清理)
    ├── creation_workflow_page.dart
    ├── workflow_controller.dart
    └── views/
```

---

## 🎯 测试清单

### ✅ 基本流程
- [ ] 点击"创建作品"弹出命名框
- [ ] 输入名称后作品立即出现在列表
- [ ] 进入选择界面，标题显示作品名称
- [ ] 选择界面可拖动/最小化/最大化/关闭
- [ ] 点击故事输入进入对应页面
- [ ] 点击剧本输入进入对应页面

### ✅ 故事输入流程
- [ ] 左右分栏布局正确
- [ ] 粘贴故事到左边
- [ ] 点击提示词按钮打开管理器
- [ ] 选择提示词预设
- [ ] 点击生成剧本（2秒后显示）
- [ ] 右边显示生成的剧本
- [ ] 点击下一步进入作品空间

### ✅ 剧本输入流程
- [ ] 粘贴剧本到文本框
- [ ] 下一步按钮在右上角
- [ ] 剧本为空时下一步禁用
- [ ] 点击下一步进入作品空间

### ✅ 作品空间
- [ ] 显示剧本内容
- [ ] 可以编辑修改
- [ ] 右上角4个按钮显示
- [ ] 编辑后自动保存
- [ ] 返回后作品保留

### ✅ 数据持久化
- [ ] 创建作品后立即保存到列表
- [ ] 编辑内容实时保存
- [ ] 关闭再打开数据不丢失
- [ ] 多作品数据独立

### ✅ 窗口管理
- [ ] 所有副界面可拖动
- [ ] 最小化功能正常
- [ ] 最大化/还原功能正常
- [ ] 关闭按钮正常

---

## 🎊 完成状态

### ✅ 已实现
- ✅ 作品命名前置
- ✅ 立即创建作品
- ✅ 选择界面
- ✅ 故事输入页面
- ✅ 剧本输入页面
- ✅ 提示词预设管理
- ✅ 作品空间（剧本编辑）
- ✅ 自动保存机制
- ✅ 窗口管理（拖动/最小化/最大化）
- ✅ 多作品独立存储
- ✅ 颜色主题调整（灰色系）

### 🚧 待实现
- ⏳ 角色管理
- ⏳ 场景管理
- ⏳ 物品管理
- ⏳ 作品空间的下一步功能
- ⏳ 真实LLM API集成

---

**版本**: v3.0  
**更新日期**: 2026-01-28  
**状态**: ✅ 核心流程完成 | 🎨 UI优化完成 | 💾 数据持久化完成
